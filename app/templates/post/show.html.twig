{% extends 'base.html.twig' %}

{% block title %}{{post.title}}{% endblock %}

{% block body %}
<div class="container post-container">
    <div class="post-header">
        <a href="{{ path('app_home') }}" class="btn-back">‚Üê Retour</a>
        <h1>{{ post.title }}</h1>
    </div>

    <div class="post-meta">
        <span class="category">{{ post.category.name }}</span>
        <span class="date">{{ post.createdAt|date('d/m/Y √† H:i') }}</span>
    </div>

    {% if post.imagePath %}
        <div class="post-featured-image">
            <img src="{{ asset('uploads/posts/' ~ post.imagePath) }}" alt="{{ post.title }}">
        </div>
    {% endif %}

    <div class="post-content">
        {{ post.content }}
    </div>

    {% if is_granted('ROLE_ADMIN') %}
        <div class="post-actions">
            <a href="{{ path('app_post_edit', {'id': post.id}) }}" class="btn btn-primary">‚úèÔ∏è √âditer</a>
            <form method="post" action="{{ path('app_post_delete', {'id': post.id}) }}" style="display:inline;">
                <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ post.id) }}">
                <button type="submit" class="btn btn-danger" onclick="return confirm('√™tes-vous s√ªr ?')">üóëÔ∏è Supprimer</button>
            </form>
        </div>
    {% endif %}

    <div class="comments-section">
        <h2>üí¨ Commentaires ({{ post.comments|length }})</h2>

        {% if is_granted('ROLE_USER') %}
            <div class="comment-form-section">
                <h3>Ajouter un commentaire</h3>
                {{ form_start(form, {'action': path('app_comment_new', {'postId': post.id}), 'attr': {'class': 'comment-form'}}) }}
                    {{ form_widget(form.content, {'attr': {'class': 'comment-input', 'placeholder': '√âcrivez votre commentaire...'}}) }}
                    <button type="submit" class="btn btn-primary">Publier le commentaire</button>
                {{ form_end(form) }}
                <p class="comment-note">Votre commentaire sera approuv√© avant d'√™tre visible</p>
            </div>
        {% else %}
            <p class="login-prompt"><a href="{{ path('app_login') }}">Connectez-vous</a> pour laisser un commentaire</p>
        {% endif %}

        {% if post.comments|length > 0 %}
            <div class="comments-list">
                {% for comment in post.comments %}
                    {% if comment.approved or is_granted('ROLE_ADMIN') %}
                        <div class="comment {% if not comment.approved %}comment-pending{% endif %}">
                            <div class="comment-header">
                                <strong class="comment-author">{{ comment.author.firstName }} {{ comment.author.lastName }}</strong>
                                <span class="comment-date">{{ comment.createdAt|date('d/m/Y √† H:i') }}</span>
                                {% if not comment.approved %}
                                    <span class="comment-status">En attente d'approbation</span>
                                {% endif %}
                            </div>
                            <p class="comment-text">{{ comment.content }}</p>
                            {% if (app.user is same as comment.author) or is_granted('ROLE_ADMIN') %}
                                <form method="post" action="{{ path('app_comment_delete', {'id': comment.id}) }}" style="display:inline;">
                                    <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ comment.id) }}">
                                    <button type="submit" class="btn-delete-comment" onclick="return confirm('√ätes-vous s√ªr ?')">Supprimer</button>
                                </form>
                            {% endif %}
                        </div>
                    {% endif %}
                {% endfor %}
            </div>
        {% else %}
            <p class="no-comments">Aucun commentaire pour le moment. Soyez le premier √† commenter!</p>
        {% endif %}
    </div>
</div>

<style>
    .post-container {
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
    }

    .post-header {
        margin-bottom: 30px;
    }

    .btn-back {
        display: inline-block;
        margin-bottom: 15px;
        color: #007bff;
        text-decoration: none;
        font-size: 0.95em;
    }

    .btn-back:hover {
        text-decoration: underline;
    }

    .post-header h1 {
        margin: 0;
        color: #333;
        font-size: 2.5em;
    }

    .post-meta {
        display: flex;
        gap: 15px;
        align-items: center;
        margin-bottom: 20px;
        font-size: 0.9em;
        color: #666;
    }

    .category {
        background-color: #007bff;
        color: white;
        padding: 4px 12px;
        border-radius: 20px;
        font-weight: 600;
    }

    .post-featured-image {
        margin: 30px 0;
        text-align: center;
    }

    .post-featured-image img {
        max-width: 100%;
        max-height: 400px;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .post-content {
        font-size: 1.05em;
        line-height: 1.8;
        color: #333;
        margin: 30px 0;
        padding: 20px;
        background: #f9f9f9;
        border-radius: 4px;
        white-space: pre-wrap;
        word-wrap: break-word;
    }

    .post-actions {
        margin: 30px 0;
        padding: 20px;
        border-top: 1px solid #eee;
        border-bottom: 1px solid #eee;
        display: flex;
        gap: 10px;
    }

    .btn {
        display: inline-block;
        padding: 10px 20px;
        text-decoration: none;
        border-radius: 4px;
        border: none;
        cursor: pointer;
        font-size: 0.95em;
        transition: opacity 0.3s;
    }

    .btn-primary {
        background-color: #007bff;
        color: white;
    }

    .btn-danger {
        background-color: #dc3545;
        color: white;
    }

    .btn:hover {
        opacity: 0.85;
    }

    .comments-section {
        margin-top: 40px;
        padding: 20px;
        border-top: 2px solid #eee;
    }

    .comments-section h2 {
        margin-top: 0;
        color: #333;
    }

    .comment-form-section {
        background: #f9f9f9;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 30px;
    }

    .comment-form-section h3 {
        margin-top: 0;
        color: #333;
    }

    .comment-form {
        display: grid;
        gap: 10px;
    }

    .comment-input {
        width: 100%;
        padding: 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-family: inherit;
        font-size: 0.95em;
        resize: vertical;
        min-height: 100px;
        box-sizing: border-box;
    }

    .comment-input:focus {
        outline: none;
        border-color: #007bff;
        box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
    }

    .comment-note {
        font-size: 0.85em;
        color: #666;
        margin: 10px 0 0 0;
    }

    .login-prompt {
        background: #e7f3ff;
        padding: 15px;
        border-radius: 4px;
        color: #004085;
        margin: 0;
    }

    .login-prompt a {
        color: #0056b3;
        font-weight: 600;
    }

    .comments-list {
        display: grid;
        gap: 20px;
    }

    .comment {
        background: #f9f9f9;
        padding: 15px;
        border-left: 3px solid #007bff;
        border-radius: 4px;
    }

    .comment-pending {
        border-left-color: #ffc107;
        background: #fffbf0;
    }

    .comment-header {
        display: flex;
        align-items: center;
        gap: 15px;
        margin-bottom: 10px;
        flex-wrap: wrap;
    }

    .comment-author {
        color: #333;
        font-size: 0.95em;
    }

    .comment-date {
        color: #999;
        font-size: 0.85em;
    }

    .comment-status {
        background-color: #ffc107;
        color: #333;
        padding: 2px 8px;
        border-radius: 3px;
        font-size: 0.8em;
        font-weight: 600;
    }

    .comment-text {
        margin: 10px 0;
        color: #555;
        font-size: 0.95em;
        line-height: 1.6;
        white-space: pre-wrap;
        word-wrap: break-word;
    }

    .btn-delete-comment {
        background: none;
        border: none;
        color: #dc3545;
        cursor: pointer;
        text-decoration: underline;
        font-size: 0.85em;
        padding: 0;
        margin: 10px 0 0 0;
    }

    .btn-delete-comment:hover {
        color: #c82333;
    }

    .no-comments {
        color: #999;
        font-style: italic;
        margin: 0;
        padding: 20px;
        text-align: center;
        background: #f9f9f9;
        border-radius: 4px;
    }

    @media (max-width: 768px) {
        .post-header h1 {
            font-size: 1.8em;
        }

        .post-meta {
            flex-direction: column;
            align-items: flex-start;
        }

        .post-actions {
            flex-direction: column;
        }

        .btn {
            width: 100%;
            text-align: center;
        }

        .comment-header {
            flex-direction: column;
            align-items: flex-start;
        }
    }
</style>
{% endblock %}

